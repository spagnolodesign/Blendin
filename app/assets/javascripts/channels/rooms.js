jQuery(document).on('turbolinks:load', function() {
  var messages, message, typing;
  var messages_to_bottom, setMessage;
  var init = $('#messages').length > 0;
  var user = window.userId;

  messages = $('#messages');
  typing = $('#typing');
  typing.hide();

  if (!init) return;

  messages_to_bottom = function() {
    $(window).scrollTop(messages.prop("scrollHeight"));
  };

  setMessage = function(){
      message = $('.message');
      message.each(function(){
        var dataUser = $(this).data('user')
        if (dataUser == user) {
          $(this).addClass('sent');
        }else{
          $(this).addClass('received');
        }
      });


  };

  messages_to_bottom();
  setMessage();


  App.global_chat = App.cable.subscriptions.create({
    channel: "ChatRoomsChannel",
    chat_room_id: messages.data('chat-room-id')
  }, {
    connected: function() {
      console.log('im ready')
    },
    disconnected: function() {
      console.log('im out')
    },
    received: function(data) {
      var action = data['action'];
      var isTyping = data['action'] === "TYPING";
      if (!isTyping) {
        messages.append(data['message']);
        typing.hide();
      }else{
        typing.show();
      }
      messages_to_bottom();
      setMessage();

    },
    send_message: function(message, chat_room_id) {
      return this.perform('send_message', {
        message: message,
        chat_room_id: chat_room_id
      });
    },
    send_typing: function(chat_room_id) {
      return this.perform('send_typing', {
        chat_room_id: chat_room_id
      });
    }
  });
  
  $('#new_message').submit(function(e) {
    var $this, textarea;
    $this = $(this);
    textarea = $this.find('#message_body');
    if ($.trim(textarea.val()).length > 1) {
      App.global_chat.send_message(textarea.val(), messages.data('chat-room-id'));
      textarea.val('');
    }
    e.preventDefault();
    return false;
  });

  $('#new_message').keypress(function(e) {
    App.global_chat.send_typing(messages.data('chat-room-id'));
  });

});

// ---
// generated by coffee-script 1.9.2